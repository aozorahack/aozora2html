#!/usr/bin/env ruby

require 'aozora2html'
require 'optparse'

# override Aozora2Html#push_chars
#
# Original Aozora2Html#push_chars does not convert "'" into '&#39;'; it's old behaivor
# of CGI.escapeHTML().
#
class Aozora2Html
  def push_chars(obj)
    if obj.is_a?(Array)
      obj.each{|x|
        push_chars(x)
      }
    elsif obj.is_a?(String)
      if obj.length == 1
        obj = obj.gsub(/[&\"<>]/, {'&' => '&amp;', '"' => '&quot;', '<' => '&lt;', '>' => '&gt;'})
      end
      obj.each_char{|x|
        push_char(x)
      }
    else
      push_char(obj)
    end
  end
end

opt = OptionParser.new("Usage: aozora2html [options] <text file> <html file>\n")
opt.on('--gaiji-dir DIR', 'setting gaiji directory')
opt.on('--use-jisx0213', 'setting gaiji directory')
opt.version = Aozora2Html::VERSION
options = opt.getopts

if options["gaiji-dir"]
  $gaiji_dir = options["gaiji-dir"]
end

if options["use-jisx0213"]
  Embed_Gaiji_tag.use_jisx0213 = true
end

if ARGV.size != 2
  $stderr.print opt.banner
  exit 1
end

if !File.exists?(ARGV[0])
  $stderr.print "file not found: #{ARGV[0]}\n"
  exit 1
end

if File.extname(ARGV[0]) == ".zip"
  require "tempfile"
  Dir.mktmpdir do |dir|
    tmpfile = File.join(dir, "aozora.txt")
    Aozora2Html::Zip.unzip(ARGV[0], tmpfile)
    Aozora2Html.new(tmpfile, ARGV[1]).process
  end
else
  Aozora2Html.new(ARGV[0], ARGV[1]).process
end

